{% extends '_.html' %}
{% load static %}
{% block main %}

<style>
    input,
    select,
    textarea {
        margin-bottom: 20px;
        margin-top: 4px;
    }

    /* Parent Section Padding */
    .register-form {
        padding: 10px;
    }

    /* Align columns equally on desktop */
    @media (min-width: 768px) {
        .right-form-wrapper {
            height: 100%;
            max-height: 80vh;
            /* Adjust based on your left section height */
            overflow-y: auto;
            /* Makes the right form scrollable */
            padding-right: 10px;
        }

        .left-info-wrapper {
            height: 100%;
            max-height: 80vh;
            overflow-y: auto;
            /* Optional: Left side scroll too */
            padding-right: 10px;
        }
    }

    /* Prevent scrollbars on mobile */
    @media (max-width: 767px) {

        .right-form-wrapper,
        .left-info-wrapper {
            max-height: unset;
            overflow: visible;
        }
    }

    /* For better spacing inside list */
    .register-list li {
        margin-bottom: 10px;
    }
</style>


<section class="register-form">
    <div class="container-fluid p-2">

        <!-- Bootstrap Row -->
        <div class="row">

            <!-- LEFT SIDE CONTENT -->
            <div class="col-md-6 mb-4">
                <div class="left-info-wrapper">
                    <h5 class="register-title mb-4">
                        {{settings.current_season.title}} - {{settings.current_season.year}}
                    </h5>
                    <ul class="register-list">
                        <!-- <li>1.<b>Trails Date :</b> {{settings.current_season.start_date}}</li> -->
                        <li><b>Team Registration fees :</b> Rs. {{settings.current_season.amount}}/-</li>
                        <!-- <li>4.<b>Franchise fees :</b> Rs. 15000/-</li> -->

                        <li>
                            <b>Player Photo</b><br>
                            *Update New and clear Photo <br>
                            No Selfi or photo attached with trophy or any other objects not permitted<br>
                            Model as given Below<br>
                            <img style="height: 200px; width: 200px;"
                                src="https://www.hindustantimes.com/static-content/1y/cricket-logos/players/virat-kohli.png">
                        </li>

                        <li>
                            <b>ID for address Prof</b><br>
                            For location confirmation. Fake data = rejection.
                        </li>
                    </ul>

                    <h5 class="register-subtitle text-start">
                        Last date for registration : {{settings.current_season.end_date}}.
                    </h5>
                </div>
            </div>

            <!-- RIGHT SIDE CONTENT (Scrollable on Desktop) -->
            <div class="col-md-6">
                <div class="right-form-wrapper">
                    <h3 class="banner-title mb-3">Registration Form</h3>
                    <p class="register-title" ></p>
                    <form enctype="multipart/form-data" method="post">
                        {% csrf_token %}
                        {{ form.as_p }}

                        <!-- Preview + Change Image Button -->
                        <div id="previewSection" style="display:none; text-align:center; margin-bottom:20px;">
                            <img id="previewImage"
                                style="width:200px;height:200px;object-fit:cover;border-radius:10px;border:1px solid #aaa;">
                            <br>
                            <button type="button" id="changeImageBtn" class="btn btn-warning mt-2">Change Image</button>
                        </div>

                        <!-- Crop Modal -->
                        <div id="cropModal" style="display:none; position:fixed; left:0; top:0; width:100%; height:100%;
                    background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
                            <div
                                style="background:#fff; padding:20px; border-radius:10px; max-height: 90vh; max-width: 90vh; overflow: scroll; scroll-behavior: smooth;">
                                <img id="cropImage" style="max-width:300px;">
                                <div class="text-center mt-2">
                                    <button id="cropSaveBtn" type="button" class="btn btn-success">Save</button>
                                    <button id="cropCancelBtn" type="button" class="btn btn-secondary">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 text-end">
                            <button type="submit" name="Register" class="fancy-button w-100">
                                {{ button_message|default:"Proceed to Pay" }}
                            </button>
                        </div>

                    </form>
                </div>
            </div>

        </div>

    </div> <!-- /container -->
</section>

<!-- CropperJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />

<script>
    let email_field = document.getElementById("id_email");
    let user_email = "{{ user.email }}";

    if (email_field && user_email) {
        email_field.value = user_email;
        email_field.readOnly = true;
    }

    document.getElementById("id_pin_code").setAttribute("min", "100000");
    document.getElementById("id_pin_code").setAttribute("max", "999999");
    document.getElementById("id_pin_code").addEventListener("invalid", function() {
        alert("Please enter a valid PIN Code");
    });
    document.getElementById("id_adhar_card").setAttribute("min", "100000000000");
    document.getElementById("id_adhar_card").setAttribute("max", "999999999999");
    document.getElementById("id_adhar_card").addEventListener("invalid", function() {
        alert("Please enter a valid Aadhar Card Number");
    });
    document.getElementById("id_mobile").setAttribute("min", "1000000000");
    document.getElementById("id_mobile").setAttribute("max", "9999999999");
    document.getElementById("id_mobile").addEventListener("invalid", function() {
        alert("Please enter a valid 10-digit Mobile Number");
    });
    document.getElementById("id_wathsapp_number").setAttribute("min", "1000000000");
    document.getElementById("id_wathsapp_number").setAttribute("max", "9999999999");
    document.getElementById("id_wathsapp_number").addEventListener("invalid", function() {
        alert("Please enter a valid 10-digit WhatsApp Number");
    });
    document.getElementById("id_age").setAttribute("min", "5");
    document.getElementById("id_age").setAttribute("max", "60");
    document.getElementById("id_age").addEventListener("invalid", function() {
        alert("Please enter a valid age between 5 and 60.");
    });

    /* Your same JS â€” unchanged */
    document.addEventListener("DOMContentLoaded", function () {

        const fileInput = document.getElementById("id_player_image");
        const previewSection = document.getElementById("previewSection");
        const previewImage = document.getElementById("previewImage");
        const changeImageBtn = document.getElementById("changeImageBtn");

        const cropModal = document.getElementById("cropModal");
        const cropImage = document.getElementById("cropImage");
        const cropSaveBtn = document.getElementById("cropSaveBtn");
        const cropCancelBtn = document.getElementById("cropCancelBtn");

        let cropper;

        if (!fileInput) return;

        {% if form.instance.player_image %}
        previewImage.src = "{{ form.instance.player_image.url }}";
        previewSection.style.display = "block";
        fileInput.style.display = "none";
        {% endif %}

        changeImageBtn?.addEventListener("click", () => fileInput.click());

        fileInput.addEventListener("change", function (e) {
            if (!e.target.files.length) return;

            const reader = new FileReader();
            reader.onload = evt => {
                cropImage.src = evt.target.result;
                cropModal.style.display = "flex";
                cropper = new Cropper(cropImage, { aspectRatio: 1, viewMode: 2 });
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        cropCancelBtn.addEventListener("click", () => {
            cropper.destroy();
            cropModal.style.display = "none";
            fileInput.value = "";
        });

        cropSaveBtn.addEventListener("click", function () {
            const canvas = cropper.getCroppedCanvas({ width: 600, height: 600 });

            canvas.toBlob(function process(blob) {
                let quality = 0.9;

                function compress() {
                    canvas.toBlob((compressedBlob) => {
                        if (compressedBlob.size <= 500 * 1024 || quality < 0.2) {

                            const newFile = new File([compressedBlob], "player.jpg", { type: "image/jpeg" });
                            const dt = new DataTransfer();
                            dt.items.add(newFile);
                            fileInput.files = dt.files;

                            previewImage.src = URL.createObjectURL(compressedBlob);
                            previewSection.style.display = "block";
                            cropModal.style.display = "none";

                        } else {
                            quality -= 0.1;
                            compress();
                        }
                    }, "image/jpeg", quality);
                }
                compress();
            }, "image/jpeg", 0.9);
        
        });
        
        if(document.getElementById("id_player_image").style.display == "none"){
            document.getElementById("id_player_image").parentElement.style.display = "none";
        }

    });
</script>

{% endblock %}