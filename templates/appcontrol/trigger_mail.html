<!DOCTYPE html>
<html>
    <head>
        <title>Trigger Mail</title>
        <style>
            body { font-family: Arial; padding: 20px; }
            table { width: 100%; border-collapse: collapse; margin-top: 20px; }
            th, td { padding: 8px; border: 1px solid #ccc; }
            th { background: #f2f2f2; }
            select, input[type="text"] { padding: 6px; }
            button { padding: 6px 12px; margin-top: 12px; }

            .messages {
                margin-bottom: 15px;
            }

            .messages div {
                padding: 10px;
                border-radius: 5px;
                margin-bottom: 8px;
                font-size: 14px;
            }

            .success {
                background: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .error {
                background: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
        </style>
    </head>

    <body>
        <h2>Welcome {{user.username}},</h2>
        <ul>
            <li><a href="{% url 'con_upload' %}">Data Upload</a></li>
            <li><a href="{% url 'con_trigger_mail' %}">Trigger Mail</a></li>
        </ul>
        <h2>Send Registration Emails</h2>
        <div class="messages">
            {% for message in messages %}
            <div class="{% if message.tags %}{{message.tags}}{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
        </div>

        <form method="GET">
            <label>Season:</label>
            <select name="season_id" required>
                <option value="">-- choose --</option>
                {% for s in seasons %}
                    <option value="{{s.id}}" {% if request.GET.season_id == s.id|stringformat:'s' %}selected{% endif %}>
                        {{s.title}} - {{s.year}}
                    </option>
                {% endfor %}
            </select>

            <label style="margin-left:20px;">Mail Status:</label>
            <select name="mail_filter">
                <option value="all" {% if mail_filter == "all" %}selected{% endif %}>All</option>
                <option value="unsent" {% if mail_filter == "unsent" %}selected{% endif %}>Unsent Only</option>
                <option value="sent" {% if mail_filter == "sent" %}selected{% endif %}>Sent Only</option>
            </select>

            <input type="text" name="q" placeholder="Search Reg ID / User / Player"
                value="{{request.GET.q}}" style="margin-left:20px;">

            <button type="submit">Apply</button>
        </form>

        {% if registrations %}
        <form method="POST">
            {% csrf_token %}
            <table>
                <thead>
                    <tr>
                        <th><input type="checkbox" id="select_all"></th>
                        <th>Reg ID</th>
                        <th>Player Name</th>
                        <th>User ID</th>
                        <th>Email</th>
                        <th>Mail Sent</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in registrations %}
                    <tr>
                        <td>
                            <input type="checkbox" class="row_check" name="selected_ids" value="{{r.id}}">
                        </td>
                        <td>{{r.reg_id}}</td>
                        <td>{{r.player_name}}</td>
                        <td>{{r.user.username}}</td>
                        <td>{{r.user.email}}</td>
                        <td>{{r.is_mail_sent}}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <button type="submit">Send Email</button>
        </form>
        {% endif %}

        <script>
            const selectAll = document.getElementById("select_all");
            const checkboxes = document.querySelectorAll(".row_check");

            selectAll.addEventListener("change", () => {
                checkboxes.forEach(cb => cb.checked = selectAll.checked);
            });

            checkboxes.forEach(cb => {
                cb.addEventListener("change", () => {
                    if (![...checkboxes].every(x => x.checked)) {
                        selectAll.checked = false;
                    } else {
                        selectAll.checked = true;
                    }
                });
            });
        </script>

    </body>
</html>
